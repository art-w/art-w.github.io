<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Client_connection (docs.findlib-1.h2.H2.Client_connection)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.1"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script><script>let base_url = '../../../../../';
let search_urls = ['../../../../db.js','../../../../sherlodoc.js'];
</script><script src="../../../../odoc.support/odoc_search.js" defer="defer"></script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../../../index.html">docs</a> &#x00BB; <a href="../../../index.html">findlib-1</a> &#x00BB; <a href="../../index.html">h2</a> &#x00BB; <a href="../index.html">H2</a> &#x00BB; Client_connection</nav><div class="odoc-search"><div class="search-inner"><input class="search-bar" placeholder="ðŸ”Ž Search..."/><div class="search-snake"></div><div class="search-result"></div></div></div><header class="odoc-preamble"><h1>Module <code><span>H2.Client_connection</span></code></h1></header><div class="odoc-content"><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-error"><a href="#type-error" class="anchor"></a><code><span><span class="keyword">type</span> error</span><span> = </span><span>[ </span></code><ol><li id="type-error.Malformed_response" class="def variant constructor anchored"><a href="#type-error.Malformed_response" class="anchor"></a><code><span>| </span><span>`Malformed_response <span class="keyword">of</span> string</span></code></li><li id="type-error.Invalid_response_body_length" class="def variant constructor anchored"><a href="#type-error.Invalid_response_body_length" class="anchor"></a><code><span>| </span><span>`Invalid_response_body_length <span class="keyword">of</span> <a href="../Response/index.html#type-t">Response.t</a></span></code></li><li id="type-error.Protocol_error" class="def variant constructor anchored"><a href="#type-error.Protocol_error" class="anchor"></a><code><span>| </span><span>`Protocol_error <span class="keyword">of</span> <a href="../Error_code/index.html#type-t">Error_code.t</a> * string</span></code></li><li id="type-error.Exn" class="def variant constructor anchored"><a href="#type-error.Exn" class="anchor"></a><code><span>| </span><span>`Exn <span class="keyword">of</span> exn</span></code></li></ol><code><span> ]</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-trailers_handler"><a href="#type-trailers_handler" class="anchor"></a><code><span><span class="keyword">type</span> trailers_handler</span><span> = <span><a href="../Headers/index.html#type-t">Headers.t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-response_handler"><a href="#type-response_handler" class="anchor"></a><code><span><span class="keyword">type</span> response_handler</span><span> = <span><a href="../Response/index.html#type-t">Response.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Body/Reader/index.html#type-t">Body.Reader.t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-error_handler"><a href="#type-error_handler" class="anchor"></a><code><span><span class="keyword">type</span> error_handler</span><span> = <span><a href="#type-error">error</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-create"><a href="#val-create" class="anchor"></a><code><span><span class="keyword">val</span> create : 
  <span><span class="optlabel">?config</span>:<a href="../Config/index.html#type-t">Config.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?push_handler</span>:<span>(<span><a href="../Request/index.html#type-t">Request.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(<a href="#type-response_handler">response_handler</a>, unit)</span> <a href="../../../../stdlib/Stdlib/index.html#type-result">result</a></span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">error_handler</span>:<a href="#type-error_handler">error_handler</a> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>create ?config ?push_handler ~error_handler</code> creates a connection that can be used to interact with servers over the HTTP/2 protocol.</p><p><code>error_handler</code> will be called for <em>connection-level</em> errors. HTTP/2 is multiplexed over a single TCP connection and distinguishes connection-level errors from stream-level errors. See See <a href="https://tools.ietf.org/html/rfc7540#section-5.4">RFC7540Â§5.4</a> for more details.</p><p>If present, <code>push_handler</code> will be called upon the receipt of PUSH_PROMISE frames with the request promised by the server. This function should return <code>Ok response_handler</code> if the client wishes to accept the pushed request. In this case, <code>response_handler</code> will be called once the server respondes to the pushed request. Returning <code>Error ()</code> will signal to h2 that the client is choosing to reject the request that the server is pushing, and its stream will be closed, as per the following excerpt from the HTTP/2 specification:</p><p>From RFC7540Â§6.6: Recipients of PUSH_PROMISE frames can choose to reject promised streams by returning a RST_STREAM referencing the promised stream identifier back to the sender of the PUSH_PROMISE.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-create_h2c"><a href="#val-create_h2c" class="anchor"></a><code><span><span class="keyword">val</span> create_h2c : 
  <span><span class="optlabel">?config</span>:<a href="../Config/index.html#type-t">Config.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?push_handler</span>:<span>(<span><a href="../Request/index.html#type-t">Request.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(<a href="#type-response_handler">response_handler</a>, unit)</span> <a href="../../../../stdlib/Stdlib/index.html#type-result">result</a></span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">http_request</span>:<a href="../../../httpaf/Httpaf/Request/index.html#type-t">Httpaf.Request.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">error_handler</span>:<a href="#type-error_handler">error_handler</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<a href="#type-response_handler">response_handler</a> * <a href="#type-error_handler">error_handler</a>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<a href="#type-t">t</a>, string)</span> <a href="../../../../stdlib/Stdlib/index.html#type-result">result</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-request"><a href="#val-request" class="anchor"></a><code><span><span class="keyword">val</span> request : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?flush_headers_immediately</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?trailers_handler</span>:<a href="#type-trailers_handler">trailers_handler</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Request/index.html#type-t">Request.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">error_handler</span>:<a href="#type-error_handler">error_handler</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">response_handler</span>:<a href="#type-response_handler">response_handler</a> <span class="arrow">&#45;&gt;</span></span>
  <a href="../Body/Writer/index.html#type-t">Body.Writer.t</a></span></code></div><div class="spec-doc"><p><code>request connection ?trailers_handler req ~error_handler
      ~response_handler</code> opens a new HTTP/2 stream with <code>req</code> and returns a request body that can be written to. Once a response arrives, <code>response_handler</code> will be called with its headers and body. <code>error_handler</code> will be called for <em>stream-level</em> errors. If there are any trailers they will be parsed and passed to <code>trailers_handler</code>.</p><p>HTTP/2 is multiplexed over a single TCP connection and distinguishes connection-level errors from stream-level errors. See <a href="https://tools.ietf.org/html/rfc7540#section-5.4">RFC7540Â§5.4</a> for more details.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-ping"><a href="#val-ping" class="anchor"></a><code><span><span class="keyword">val</span> ping : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?payload</span>:<a href="../../../bigstringaf/Bigstringaf/index.html#type-t">Bigstringaf.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?off</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span><span><span>(unit, <span>[ `EOF ]</span>)</span> <a href="../../../../stdlib/Stdlib/index.html#type-result">result</a></span> <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div><div class="spec-doc"><p><code>ping connection ?payload ?off f</code> sends an HTTP/2 PING frame and registers <code>f</code> to be called when the server has sent an acknowledgement for it. A custom <code>payload</code> (and offset into that payload) for the PING frame may also be provided. If not, a payload with all bytes set to zero will be used. Note that a PING frame's payload <b>must</b> be 8 octets in length.</p><p>In HTTP/2, the PING frame is a mechanism for measuring a minimal round-trip time from the sender, as well as determining whether an idle connection is still functional. See <a href="https://tools.ietf.org/html/rfc7540#section-5.4">RFC7540Â§5.4</a> for more details.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-shutdown"><a href="#val-shutdown" class="anchor"></a><code><span><span class="keyword">val</span> shutdown : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>shutdown connection</code> initiates the graceful shutdown of <code>connection</code>, and sends an HTTP/2 GOAWAY frame with NO_ERROR on the output channel (See <a href="https://tools.ietf.org/html/rfc7540#section-6.8">RFC7540Â§6.8</a> for more details).</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-next_read_operation"><a href="#val-next_read_operation" class="anchor"></a><code><span><span class="keyword">val</span> next_read_operation : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>[&gt; `Read <span>| `Close</span> ]</span></span></code></div><div class="spec-doc"><p><code>next_read_operation t</code> returns a value describing the next operation that the caller should conduct on behalf of the connection.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-read"><a href="#val-read" class="anchor"></a><code><span><span class="keyword">val</span> read : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../bigstringaf/Bigstringaf/index.html#type-t">Bigstringaf.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="label">off</span>:int <span class="arrow">&#45;&gt;</span></span> <span><span class="label">len</span>:int <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>read t bigstring ~off ~len</code> reads bytes of input from the provided range of <code>bigstring</code> and returns the number of bytes consumed by the connection. <a href="#val-read"><code>read</code></a> should be called after <a href="#val-next_read_operation"><code>next_read_operation</code></a> returns a <code>`Read</code> value and additional input is available for the connection to consume.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-read_eof"><a href="#val-read_eof" class="anchor"></a><code><span><span class="keyword">val</span> read_eof : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../bigstringaf/Bigstringaf/index.html#type-t">Bigstringaf.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="label">off</span>:int <span class="arrow">&#45;&gt;</span></span> <span><span class="label">len</span>:int <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>read t bigstring ~off ~len</code> reads bytes of input from the provided range of <code>bigstring</code> and returns the number of bytes consumed by the connection. <a href="#val-read"><code>read</code></a> should be called after <a href="#val-next_read_operation"><code>next_read_operation</code></a> returns a <code>`Read</code> and an EOF has been received from the communication channel. The connection will attempt to consume any buffered input and then shutdown the HTTP parser for the connection.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-next_write_operation"><a href="#val-next_write_operation" class="anchor"></a><code><span><span class="keyword">val</span> next_write_operation : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>[ <span>`Write of <span><span><a href="../../../bigstringaf/Bigstringaf/index.html#type-t">Bigstringaf.t</a> <a href="../IOVec/index.html#type-t">IOVec.t</a></span> list</span></span> <span>| `Yield</span> <span><span>| `Close</span> of int</span> ]</span></span></code></div><div class="spec-doc"><p><code>next_write_operation t</code> returns a value describing the next operation that the caller should conduct on behalf of the connection.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-report_write_result"><a href="#val-report_write_result" class="anchor"></a><code><span><span class="keyword">val</span> report_write_result : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>[ <span>`Ok of int</span> <span>| `Closed</span> ]</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>report_write_result t result</code> reports the result of the latest write attempt to the connection. <a href="#val-report_write_result"><code>report_write_result</code></a> should be called after a call to <a href="#val-next_write_operation"><code>next_write_operation</code></a> that returns a <code>`Write buffer</code> value.</p><ul><li><code>`Ok n</code> indicates that the caller successfully wrote <code>n</code> bytes of output from the buffer that the caller was provided by <a href="#val-next_write_operation"><code>next_write_operation</code></a>.</li><li><code>`Closed</code> indicates that the output destination will no longer accept bytes from the write processor.</li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-yield_writer"><a href="#val-yield_writer" class="anchor"></a><code><span><span class="keyword">val</span> yield_writer : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>yield_writer t continue</code> registers with the connection to call <code>continue</code> when writing should resume. <a href="#val-yield_writer"><code>yield_writer</code></a> should be called after <a href="#val-next_write_operation"><code>next_write_operation</code></a> returns a <code>`Yield</code> value.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-yield_reader"><a href="#val-yield_reader" class="anchor"></a><code><span><span class="keyword">val</span> yield_reader : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>yield_reader t continue</code> immediately calls <code>continue</code>. This function * shouldn't generally be called and it's only here to simplify adhering * to the Gluten <code>RUNTIME</code> module type.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-report_exn"><a href="#val-report_exn" class="anchor"></a><code><span><span class="keyword">val</span> report_exn : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>exn <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>report_exn t exn</code> reports that an error <code>exn</code> has been caught and that it has been attributed to <code>t</code>. Calling this function will switch <code>t</code> into an error state. Depending on the state <code>t</code> is transitioning from, it may call its (connection-level) error handler before terminating the connection.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-is_closed"><a href="#val-is_closed" class="anchor"></a><code><span><span class="keyword">val</span> is_closed : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>is_closed t</code> is <code>true</code> if both the read and write processors have been shutdown. When this is the case <a href="#val-next_read_operation"><code>next_read_operation</code></a> will return <code>`Close _</code> and <a href="#val-next_write_operation"><code>next_write_operation</code></a> will do the same will return a <code>`Write _</code> until all buffered output has been flushed, at which point it will return <code>`Close</code>.</p></div></div></div></body></html>
